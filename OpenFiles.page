<link type="text/css" rel="stylesheet" href="<?autov('/plugins/open.files/assets/style-$theme.css')?>">
<link type="text/css" rel="stylesheet" href="<?autov('/plugins/open.files/assets/open-files.css')?>">


<h2>Process Filter Options</h2>
<div id="filterSection">
  <div class="filter-group">
    <label><input type="checkbox" class="group-toggle" data-group="system"> System Processes</label>
    <div class="filter-options hidden-group" data-group="system">
      <label><input type="checkbox" class="proc-filter" value="shfs"> shfs</label><br>
      <label><input type="checkbox" class="proc-filter" value="kworker"> kworker</label><br>
      <label><input type="checkbox" class="proc-filter" value="systemd"> systemd</label>
    </div>
  </div>

  <div class="filter-group">
    <label><input type="checkbox" class="group-toggle" data-group="unraid"> Unraid Processes</label>
    <div class="filter-options hidden-group" data-group="unraid">
      <label><input type="checkbox" class="proc-filter" value="smbd"> smbd</label><br>
      <label><input type="checkbox" class="proc-filter" value="nfsd"> nfsd</label><br>
      <label><input type="checkbox" class="proc-filter" value="mdrecoveryd"> mdrecoveryd</label>
    </div>
  </div>

  <div class="filter-group">
    <label><input type="checkbox" class="group-toggle" data-group="vm"> VM/Docker Processes</label>
    <div class="filter-options hidden-group" data-group="vm">
      <label><input type="checkbox" class="proc-filter" value="qemu"> qemu</label><br>
      <label><input type="checkbox" class="proc-filter" value="libvirt"> libvirt</label><br>
      <label><input type="checkbox" class="proc-filter" value="dockerd"> dockerd</label>
    </div>
  </div>

  <p><button onclick="refreshPage()">Apply Filter</button></p>
</div>

<table class='tablesorter shift open-files' id='tblOpenFiles'>
<thead>
  <tr>
    <th>Process</th>
    <th>Process ID</th>
    <th>Kill Process</th>
    <th>Open</th>
    <th>May Prevent Shutdown</th>
    <th>File Name and Path</th>
  </tr>
</thead>
<tbody id="open-files">
  <tr>
    <td colspan='6'><div class='spinner'></div></td>
  </tr>
</tbody>
</table>

<h3>Notes</h3>
<ul>
  <li>An entry for <code>bash</code> means you have a terminal session open with the working directory on the array.</li>
  <li>If <code>smbd</code> is listed, it means that another computer has a Samba share mounted. Files open by Samba usually won't prevent array shutdown.</li>
</ul>

<input type="button" value="Refresh" onclick="refreshPage()">
<input type="button" value="Done" onclick="done()">

<script>
const OFURL = '/plugins/open.files/include/OpenFiles.php';

function refreshPage() {
  const selected = [];
  document.querySelectorAll('.proc-filter:checked').forEach(el => selected.push(el.value));

  fetch(OFURL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: new URLSearchParams({
      action: 'open_files',
      exclude_list: JSON.stringify(selected)
    })
  })
  .then(response => response.json())
  .then(data => {
    document.getElementById('open-files').innerHTML = data;
    $('#tblOpenFiles').tablesorter({ headers: { 2: { sorter: false }, 3: { sorter: false } } });
  });

  localStorage.setItem('openFilesFilterList', JSON.stringify(selected));
}

window.addEventListener('DOMContentLoaded', () => {
  const saved = JSON.parse(localStorage.getItem('openFilesFilterList') || '[]');

  document.querySelectorAll('.proc-filter').forEach(el => {
    if (saved.includes(el.value)) el.checked = true;
  });

  document.querySelectorAll('.group-toggle').forEach(toggle => {
    const group = toggle.dataset.group;
    const hasSaved = Array.from(document.querySelectorAll(`.filter-options[data-group="${group}"] .proc-filter`)).some(el => saved.includes(el.value));

    toggle.addEventListener('change', () => {
      const visible = toggle.checked;
      const container = document.querySelector(`.filter-options[data-group="${group}"]`);
      container.style.display = visible ? 'block' : 'none';
    });

    if (hasSaved) {
      toggle.checked = true;
      document.querySelector(`.filter-options[data-group="${group}"]`).style.display = 'block';
    }
  });

  refreshPage();
});
</script>
